<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

    <title>ASC 2022 Tracker</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.ico?">
    <link rel="stylesheet" type="text/css" href="./style.css" />
    <style>
        html,
        body,
        #map-canvas {
            height: 100%;
            margin: 0px;
            padding: 0px
        }
    </style>

    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBb_CMjnm_1uymDFU-3gn5hAPEjUi7am6w"></script> -->
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>

        const map_start = new google.maps.LatLng(38.890248, -94.609152);

        var map;
        var team_markers = {};

        const vehicle_icons = [];

        const generic_icon = {
            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
            scale: 5,
            strokeWeight: 2,
            strokeColor: "#000000",
            fillOpacity: 0.8
        };

        var vehicle_following = null;
        const legend_position = google.maps.ControlPosition.LEFT_TOP;


        var legend_idx;
        function init_legend() {

            const legend = document.getElementById("legend");

            for (const legend_icon of vehicle_icons) {
                const type = legend_icon;
                const name = type.name;
                const icon = type.icon;
                const div = document.createElement("div");

                div.innerHTML = '<img src="' + icon + '"> ' + name;
                legend.appendChild(div);
            }

            legend_idx = map.controls[legend_position].getLength();
            map.controls[legend_position].push(legend);

        }

        function add_to_lengend(legend_icon) {
            const legend = map.controls[legend_position].getAt(legend_idx);

            const type = legend_icon;
            const name = type.name;
            const icon = type.icon;
            const div = document.createElement("div");

            div.innerHTML = '<img src="' + google.maps.SymbolPath.FORWARD_CLOSED_ARROW + '"> ' + name;

            legend.appendChild(div);
            vehicle_icons.push(icon);
        }

        function initialize() {

            var mapOptions = {
                zoom: 5,
                center: map_start
            };

            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

            init_legend();


            window.addEventListener('keydown', event => {
                if (event.key !== 'Escape') return;
                event.stopPropagation();
                // Handle the event.
                console.log("esc");
                vehicle_following = null;
            }, /* useCapture= */ true);

            // map.addListener('bounds_changed', function () {
            //     vehicle_following = null;
            // });

        }



        google.maps.event.addDomListener(window, 'load', initialize);

    </script>
</head>

<body>
    <div id="map-canvas"></div>
    <div id="legend">
        <h3>Legend</h3>
    </div>
</body>
<script>
    const delay = 5000;

    /* Threshold for determining whether a team's tracker is online (in seconds) */
    const online_threshold = 120;

    /* Function factory that stores closure to specific marker. */
    function get_marker_click_callback(marker) {
        return function () {
            if (vehicle_following == marker.key) {
                vehicle_following = null;
            }
            else {
                vehicle_following = marker.key
                console.log(marker.title)
            }
        }
    }

    function get_team_loc(curr_team_data) {
        const loc = new google.maps.LatLng(curr_team_data["latitude"], curr_team_data["longitude"]);
        return loc;
    }

    function new_team_marker(curr_team_data) {
        var team_icon = generic_icon;
        team_icon.fillColor = curr_team_data['color']
        var legend_icon = team_icon;
        team_icon.rotation = parseInt(curr_team_data['course'])
        console.log('Team: ' + curr_team_data['name'] + ', Color: ' + team_icon.fillColor)
        team_marker = new google.maps.Marker({
            position: get_team_loc(curr_team_data),
            map: map,
            title: curr_team_data['name'],
            icon: team_icon,
        });

        console.log(generic_icon.path);

        // Gotta figure out how to get the actual SVG from this icon.
        // add_to_lengend({ name: curr_team_data['name'], icon: legend_icon })


        team_marker.addListener("click", get_marker_click_callback(team_marker));

        return team_marker;
    }

    function set_team_online(marker, curr_team_data) {
        /* Look at time since last datapoint (in seconds) */
        const online = curr_team_data["deltatime"] < online_threshold;

        if (!online) {
            team_marker.icon.fillOpacity = 0.2;
            team_marker.icon.strokeWeight = 0.0;
        }
        else {
            team_marker.icon.fillOpacity = generic_icon.fillOpacity;
            team_marker.icon.strokeWeight = generic_icon.strokeWeight;
        }
    }

    function set_team_rotation(marker, curr_team_data) {
        var icon = marker.getIcon();
        icon.rotation = parseInt(curr_team_data['course']);
        marker.setIcon(icon);
    }

    function callDone(data) {

        console.log(data);

        for (const key in data) {
            const team_uid = key
            const curr_team_data = data[key]

            if (!(key in team_markers)) {
                team_markers[key] = new_team_marker(curr_team_data);
                team_markers[key].key = key
            }
            else {
                team_markers[key].setPosition(get_team_loc(curr_team_data));
                set_team_rotation(team_markers[key], curr_team_data)
            }

            set_team_online(team_markers[key], curr_team_data)

            if (vehicle_following != null && vehicle_following == key) {
                map.setCenter(get_team_loc(curr_team_data));
            }
        }

        setTimeout(updatePosition, delay);
    }

    function updatePosition() {
        $.ajax({
            url: 'https://fulll-send.herokuapp.com',
            dataType: 'json',
            async: true,
            crossDomain: true,
        }).done(callDone);
    }
    // call the function initally
    updatePosition();
</script>

</html>