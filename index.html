<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

    <title>WSC 2023 Tracker</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="./style.css" />
    <style>
        html,
        body,
        #map-canvas {
            height: 100%;
            margin: 0px;
            padding: 0px
        }
    </style>

    <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBb_CMjnm_1uymDFU-3gn5hAPEjUi7am6w"></script> -->

    <script>(g => { var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window; b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => { await (a = m.createElement("script")); e.set("libraries", [...r] + ""); for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]); e.set("callback", c + ".maps." + q); a.src = `https://maps.${c}apis.com/maps/api/js?` + e; d[q] = f; a.onerror = () => h = n(Error(p + " could not load.")); a.nonce = m.querySelector("script[nonce]")?.nonce || ""; m.head.append(a) })); d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)) })
            ({ key: "AIzaSyBb_CMjnm_1uymDFU-3gn5hAPEjUi7am6w", v: "weekly" });</script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>

        // var { map } = await google.maps.importLibrary("maps");

        var map;
        var team_markers = {};
        var first_load = true;

        const vehicle_icons = [];

        const marker_svg_path = "M 0 -6 L -5 6 L 0 3 L 5 6 Z";

        const marker_svg_egg_path = "M 3.12 -3.28 C 2.24 -4.88 1.04 -5.84 -0.08 -5.84 S -2.4 -4.96 -3.28 -3.28 C -4 -1.92 -4.56 -0.24 -4.56 1.04 C -4.56 2.24 -4.08 3.44 -3.28 4.24 C -2.4 5.12 -1.28 5.6 -0.08 5.6 S 2.24 5.12 3.12 4.24 C 3.92 3.36 4.4 2.24 4.4 1.04 C 4.4 -0.16 3.92 -1.92 3.12 -3.28 Z Z"
        const eggshell_color = "#f0e4d6"//"#F0EAD6";
        const eggshell_thickness = 2;

        var mn_follow_count = 0;
        const mn_follow_thresh = 5;

        const generic_icon = {

            // path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,

            path: marker_svg_path,
            scale: 2,
            strokeWeight: 2,
            strokeColor: "#000000",
            fillOpacity: 0.8,
        };

        var vehicle_following = null;
        const legend_position = google.maps.ControlPosition.LEFT_TOP;
        var legend;
        var legend_heading;
        var legend_heading_height;

        function legend_click() {
            legend.open = !legend.open;
            if (legend.open == true) {
                legend.style.maxHeight = "45%"
                legend.style.minHeight = legend_heading_height * 1.5 + "px";
                legend.style.height = "auto"
                legend.style.overflowY = "auto";
                legend_heading.classList.remove("legend_hover")
                legend_heading.style.color = "black"
            }
            else {
                legend_heading.style.color = "dimgray"
                legend_heading.classList.add("legend_hover")
                legend.style.maxHeight = null
                legend.style.minHeight = null;
                legend.style.height = legend_heading_height / 2 + "px";
                legend.style.overflowY = "hidden";
            }

        }


        var legend_idx;
        function init_legend() {

            legend = document.getElementById("legend");
            legend_heading = document.getElementById("legend_heading");
            legend_heading.onclick = legend_click
            legend_heading_height = legend_heading.clientHeight;
            legend.style.height = legend_heading_height / 2 + "px";

            for (const legend_icon of vehicle_icons) {
                const type = legend_icon;
                const name = type.name;
                const icon = type.icon;
                const div = document.createElement("div");

                div.innerHTML = '<img src="' + icon + '"> ' + name;
                legend.appendChild(div);
            }

            legend_idx = map.controls[legend_position].getLength();
            map.controls[legend_position].push(legend);

        }

        function make_team_marker(team) {
            var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            var path = document.createElementNS("http://www.w3.org/2000/svg", "path");

            svg.setAttribute("stroke", "black")
            svg.setAttribute("stroke-width", "1")
            svg.setAttribute("stroke-linecap", "round")
            svg.setAttribute("stroke-linejoin", "round")
            svg.setAttribute("width", "24px")
            svg.setAttribute("height", "24px")
            svg.setAttribute("viewBox", "-6 -7 14 14")
            svg.setAttribute("id", "marker")

            path.setAttribute('d', marker_svg_path);
            path.setAttribute('fill', team['color']);

            svg.appendChild(path);

            return svg;
        }

        function add_to_lengend(svg_marker, name, teamnum, team_marker) {
            const legend = map.controls[legend_position].getAt(legend_idx);

            const div = document.createElement("div");


            div.appendChild(svg_marker)
            const text = document.createElement("text");
            text.innerHTML = name
            text.style.userSelect = "none"
            div.appendChild(text)

            div.onclick = get_marker_click_callback(teamnum, div);
            div.title = "Follow Vehicle"
            div.style.cursor = "pointer"
            team_marker.legend_div = div

            console.log(div.innerHTML)

            legend.appendChild(div);
            // vehicle_icons.push(icon);
        }

        function get_map_start() {
            // return { lat: 38.890248, lng: -94.609152 }
            return { lat: -24.1308539, lng: 134.3255761 }
        }

        var ctaLayer;
        var current_string = "";

        function set_egg(marker) {


            const legend_children = marker.legend_div.children;

            var legend_icon_egg;

            for (i = 0; i < legend_children.length; i++) {
                if (legend_children[i].id == "marker") {
                    legend_icon_egg = legend_children[i];
                }
            }

            marker.icon.path = marker_svg_egg_path;
            marker.icon.fillColor = eggshell_color;

            var icon_path = legend_icon_egg.children[0];
            console.log(legend_icon_egg)
            console.log(icon_path)
            icon_path.setAttribute("d", marker_svg_egg_path)
            icon_path.setAttribute("fill", eggshell_color)

            marker.title = "35 EGG"
        }

        function initialize() {


            const map_start = new google.maps.LatLng(get_map_start());

            var mapOptions = {
                zoom: 5,
                center: map_start,
                streetViewControl: false
            };

            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

            init_legend();

            const iosix = document.getElementById("iosix");
            iosix.style.cursor = "pointer";
            iosix.onclick = function () { window.open(iosix_site) };
            map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(iosix);


            const asc = document.getElementById("asc");
            asc.style.cursor = "pointer";
            asc.onclick = function () { window.open(asc_site) };
            map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(asc);


            window.addEventListener('keydown', event => {
                console.log(event.key)
                if (event.key == "Escape") {
                    event.stopPropagation();
                    // Handle the event.
                    console.log("esc");
                    vehicle_following = null;
                    current_string = "";
                }
                else if (typeof (event.key) === "string" && event.key.length === 1 && event.key.match(/[a-z]/i)) {
                    event.stopPropagation();
                    current_string = current_string + event.key
                    if (current_string == "egg") {
                        console.log("EGGGGGG")
                        for (const key in team_markers) {
                            if (team_markers[key]["title"].includes("Minnesota")) {
                                set_egg(team_markers[key])
                            }
                        }

                    }
                }


            }, /* useCapture= */ true);

            ctaLayer = new google.maps.KmlLayer(
                "https://cusps.github.io/asc-tracker/wsc2023_route.kml", { preserveViewport: true }
            );
            console.log("set map");
            ctaLayer.setMap(map);

            // map.addListener('bounds_changed', function () {
            //     vehicle_following = null;
            // });

        }



        google.maps.event.addDomListener(window, 'load', initialize);

    </script>
</head>

<body>
    <div id="map-canvas"></div>
    <div id="legend" open="false">
        <div id="legend_heading" class="legend_hover">
            <h3>Vehicles</h3>
        </div>
    </div>
    <div id="iosix">
        <img src="images/iosi_sponsor.png" alt="IOSiX" style="width:100px;height:auto;">
    </div>
    <div id="asc">
        <img src="images/asc.png" alt="American Solar Challenge" style="width:100px;height:auto;">
    </div>

</body>
<script>
    const delay = 5000; // 5s
    const race = "WSC";

    /* Threshold for determining whether a team's tracker is online (in seconds) */
    const online_threshold = 120;

    const iosix_site = "https://iosix.com/"
    const asc_site = "https://americansolarchallenge.org/"

    function unfollow_marker(marker_key) {
        team_markers[marker_key].legend_div.title = "Follow Vehicle"
        team_markers[marker_key].legend_div.style.background = ""
    }

    /* Function factory that stores closure to specific marker. */
    function get_marker_click_callback(marker_key, div) {
        return function () {
            if (vehicle_following == marker_key) {
                vehicle_following = null;
                unfollow_marker(marker_key, div);
            }
            else {
                if (vehicle_following != null) {
                    unfollow_marker(vehicle_following);
                }
                vehicle_following = marker_key
                div.title = "Unfollow Vehicle"
                div.style.background = "LightGray"
                set_map_to_team(marker_key)
                if (team_markers[marker_key]["title"] == "35 Minnesota") {
                    mn_follow_count++;
                }
                if (mn_follow_count == mn_follow_thresh) {
                    set_egg(team_markers[marker_key])
                }
            }
        }
    }

    /* Function factory that stores closure to specific marker. */
    function get_marker_click_callback_info_window(marker_key) {
        return function () {
            team_markers[marker_key].info_window.open({
                anchor: team_markers[marker_key],
                map,
                shouldFocus: false,
            });

            google.maps.event.addListenerOnce(map, "click", function (event) {
                team_markers[marker_key].info_window.close();
            });

        }
    }


    function get_team_loc(team) {
        console.log(team);
        const loc = new google.maps.LatLng(team["latitude"], team["longitude"]);
        return loc;
    }

    function new_team_marker(team, teamnum) {
        console.log("new_team_marker");
        console.log(team);
        var team_icon = generic_icon;
        team_icon.fillColor = "blue" //team['color']
        var legend_icon = team_icon;
        team_icon.rotation = 0; //parseInt(team['course'])
        console.log('Team: ' + team['team']); // + ', Color: ' + team_icon.fillColor)
        number = team['teamnum']
        if (isNaN(number)) { number = "" }
        team_marker = new google.maps.Marker({
            position: get_team_loc(team),
            map: map,
            title: team['team'],
            // label: {
            //     text: number,
            //     color: 'black',
            //     fontSize: "8px"
            // },
            icon: team_icon,
        });

        team_marker.info_window = new google.maps.InfoWindow({ content: team["team"] + "<br />" + team["status"], disableAutoPan: true })


        // Gotta figure out how to get the actual SVG from this icon.
        add_to_lengend(make_team_marker(team), team['team'], teamnum, team_marker)


        team_marker.addListener("click", get_marker_click_callback_info_window(teamnum));

        return team_marker;
    }

    function is_online(team) {
        return true; //team["deltatime"] < online_threshold;
    }

    function set_team_online(marker, team) {
        /* Look at time since last datapoint (in seconds) */
        const online = is_online(team);

        const legend_children = marker.legend_div.children;

        var legend_icon;

        for (i = 0; i < legend_children.length; i++) {
            if (legend_children[i].id == "marker") {
                legend_icon = legend_children[i];
            }
        }

        if (!online) {
            marker.icon.fillOpacity = 0.5;
            marker.icon.strokeWeight = 0.0;
            legend_icon.style.fillOpacity = 0.5;
            legend_icon.setAttribute("stroke-width", 0.0);
        }
        else {
            marker.icon.fillOpacity = generic_icon.fillOpacity;
            marker.icon.strokeWeight = generic_icon.strokeWeight;
            legend_icon.style.fillOpacity = generic_icon.fillOpacity;
            legend_icon.setAttribute("stroke-width", 1);
        }
    }

    function set_team_rotation(marker, team) {
        var icon = marker.getIcon();
        icon.rotation = 0 //parseInt(team['course']);
        marker.setIcon(icon);
    }

    function set_map_to_team(team_key) {
        const team = team_markers[team_key].team_data;
        map.setCenter(get_team_loc(team));
    }

    function callDone(data) {

        data = data["items"]

        console.log(data);

        var bounds = new google.maps.LatLngBounds();
        var bounds_count = 0;


        for (const team of data) {
            teamnum = team["teamnum"]
            teamnum = Number(teamnum);

            if (!(teamnum in team_markers)) {
                team_markers[teamnum] = new_team_marker(team, teamnum);
                team_markers[teamnum].teamnum = teamnum
            }
            else {
                team_markers[teamnum].setPosition(get_team_loc(team));
                set_team_rotation(team_markers[teamnum], team)
                team_markers[teamnum].info_window.setContent(team["team"] + "<br />Distance from Darwin: " + team["distance"] + "mi.")
            }

            team_markers[teamnum].team_data = team;

            set_team_online(team_markers[teamnum], team)

            if (first_load && is_online(team) && team["team"] != "EMT") {
                bounds_count = bounds_count + 1;
                bounds.extend(team_markers[teamnum].getPosition())
            }

            if (vehicle_following != null && vehicle_following == teamnum) {
                set_map_to_team(teamnum)
            }

        }

        if (first_load) {
            first_load = false;
            console.log(bounds_count)

            if (bounds_count >= 2) {
                map.setCenter(bounds.getCenter())
                map.fitBounds(bounds);
            }
            else {
                // TODO: idk what this shit does.
                function on_stat_change() {
                    console.log("status changed")
                    console.log(ctaLayer.getDefaultViewport());
                    map.fitBounds(ctaLayer.getDefaultViewport())
                }
                if (ctaLayer.getDefaultViewport() == null) {
                    google.maps.event.addListenerOnce(ctaLayer, "defaultviewport_changed", on_stat_change);
                }
                else {
                    on_stat_change();
                }
            }

        }
        setTimeout(updatePosition, delay);
    }

    function updatePosition() {
        $.ajax({
            url: 'https://telemetry.worldsolarchallenge.org/wscearth/api/positions',
            dataType: 'json',
            async: true,
            crossDomain: true,
        }).done(callDone);
    }
    // call the function initally
    updatePosition();
</script>

</html>