<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">

    <title>ASC 2022 Tracker</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="./style.css" />
    <style>
        html,
        body,
        #map-canvas {
            height: 100%;
            margin: 0px;
            padding: 0px
        }
    </style>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBb_CMjnm_1uymDFU-3gn5hAPEjUi7am6w"></script>
    <!-- <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>


        var map;
        var team_markers = {};

        const vehicle_icons = [];

        const marker_svg_path = "M 0 -6 L -5 6 L 0 3 L 5 6 Z";


        const generic_icon = {

            // path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,

            path: marker_svg_path,
            scale: 2,
            strokeWeight: 2,
            strokeColor: "#000000",
            fillOpacity: 0.8,
        };

        var vehicle_following = null;
        const legend_position = google.maps.ControlPosition.LEFT_TOP;


        var legend_idx;
        function init_legend() {

            const legend = document.getElementById("legend");

            for (const legend_icon of vehicle_icons) {
                const type = legend_icon;
                const name = type.name;
                const icon = type.icon;
                const div = document.createElement("div");

                div.innerHTML = '<img src="' + icon + '"> ' + name;
                legend.appendChild(div);
            }

            legend_idx = map.controls[legend_position].getLength();
            map.controls[legend_position].push(legend);

        }

        function make_team_marker(curr_team_data) {
            var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            var path = document.createElementNS("http://www.w3.org/2000/svg", "path");

            svg.setAttribute("stroke", "black")
            svg.setAttribute("stroke-width", "1")
            svg.setAttribute("stroke-linecap", "round")
            svg.setAttribute("stroke-linejoin", "round")
            svg.setAttribute("width", "24px")
            svg.setAttribute("height", "24px")
            svg.setAttribute("viewBox", "-6 -7 14 14")

            path.setAttribute('d', marker_svg_path);
            path.setAttribute('fill', curr_team_data['color']);

            svg.appendChild(path);

            return svg;
        }

        function add_to_lengend(svg_marker, name, key, team_marker) {
            const legend = map.controls[legend_position].getAt(legend_idx);

            const div = document.createElement("div");


            div.appendChild(svg_marker)
            const text = document.createElement("text");
            text.innerHTML = name
            text.style.userSelect = "none"
            div.appendChild(text)

            div.onclick = get_marker_click_callback(key, div);
            div.title = "Follow Vehicle"
            div.style.cursor = "pointer"
            team_marker.legend_div = div

            console.log(div.innerHTML)

            legend.appendChild(div);
            // vehicle_icons.push(icon);
        }

        function get_map_start() {
            return { lat: 38.890248, lng: -94.609152 }
        }

        function initialize() {


            const map_start = new google.maps.LatLng(get_map_start());

            var mapOptions = {
                zoom: 5,
                center: map_start,
                streetViewControl: false
            };

            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

            init_legend();

            const iosix = document.getElementById("iosix");
            iosix.style.cursor = "pointer";
            iosix.onclick = function () { window.open(iosix_site) };
            map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(iosix);


            const asc = document.getElementById("asc");
            asc.style.cursor = "pointer";
            asc.onclick = function () { window.open(asc_site) };
            map.controls[google.maps.ControlPosition.LEFT_BOTTOM].push(asc);


            window.addEventListener('keydown', event => {
                if (event.key !== 'Escape') return;
                event.stopPropagation();
                // Handle the event.
                console.log("esc");
                vehicle_following = null;
            }, /* useCapture= */ true);

            const ctaLayer = new google.maps.KmlLayer(
                "https://cusps.github.io/asc-tracker/ASC_2022_Official_Route.kmz"
            );
            ctaLayer.setMap(map);

            // map.addListener('bounds_changed', function () {
            //     vehicle_following = null;
            // });

        }



        google.maps.event.addDomListener(window, 'load', initialize);

    </script>
</head>

<body>
    <div id="map-canvas"></div>
    <div id="legend">
        <h3>Legend</h3>
    </div>
    <div id="iosix">
        <img src="images/iosi_sponsor.png" alt="IOSiX" style="width:100px;height:auto;">
    </div>
    <div id="asc">
        <img src="images/asc.png" alt="American Solar Challenge" style="width:100px;height:auto;">
    </div>

</body>
<script>
    const delay = 5000;

    /* Threshold for determining whether a team's tracker is online (in seconds) */
    const online_threshold = 120;

    const iosix_site = "https://iosix.com/"
    const asc_site = "https://americansolarchallenge.org/"

    function unfollow_marker(marker_key) {
        team_markers[marker_key].legend_div.title = "Follow Vehicle"
        team_markers[marker_key].legend_div.style.background = ""
    }

    /* Function factory that stores closure to specific marker. */
    function get_marker_click_callback(marker_key, div) {
        return function () {
            console.log("in callback: " + vehicle_following + ", key: " + marker_key)
            if (vehicle_following == marker_key) {
                vehicle_following = null;
                unfollow_marker(marker_key, div);
                console.log(div.title)
            }
            else {
                console.log("vehicle not following me")
                console.log(vehicle_following)
                if (vehicle_following != null) {
                    unfollow_marker(vehicle_following);
                }
                vehicle_following = marker_key
                div.title = "Unfollow Vehicle"
                div.style.background = "LightGray"
                console.log(div.title)
                set_map_to_team(marker_key)
            }
        }
    }

    /* Function factory that stores closure to specific marker. */
    function get_marker_click_callback_info_window(marker_key) {
        return function () {
            team_markers[marker_key].info_window.open({
                anchor: team_markers[marker_key],
                map,
                shouldFocus: false,
            });

            google.maps.event.addListenerOnce(map, "click", function (event) {
                team_markers[marker_key].info_window.close();
            });

        }
    }


    function get_team_loc(curr_team_data) {
        const loc = new google.maps.LatLng(curr_team_data["latitude"], curr_team_data["longitude"]);
        return loc;
    }

    function new_team_marker(curr_team_data, key) {
        var team_icon = generic_icon;
        team_icon.fillColor = curr_team_data['color']
        var legend_icon = team_icon;
        team_icon.rotation = parseInt(curr_team_data['course'])
        console.log('Team: ' + curr_team_data['name'] + ', Color: ' + team_icon.fillColor)
        number = curr_team_data['name'].split(" ", 1)[0]
        if (isNaN(number)) { number = "" }
        team_marker = new google.maps.Marker({
            position: get_team_loc(curr_team_data),
            map: map,
            title: curr_team_data['name'],
            // label: {
            //     text: number,
            //     color: 'black',
            //     fontSize: "8px"
            // },
            icon: team_icon,
        });

        team_marker.info_window = new google.maps.InfoWindow({ content: curr_team_data["name"] + "<br />" + curr_team_data["status"], disableAutoPan: true })

        console.log(generic_icon.path);

        // Gotta figure out how to get the actual SVG from this icon.
        add_to_lengend(make_team_marker(curr_team_data), curr_team_data['name'], key, team_marker)


        team_marker.addListener("click", get_marker_click_callback_info_window(key));

        return team_marker;
    }

    function set_team_online(marker, curr_team_data) {
        /* Look at time since last datapoint (in seconds) */
        const online = curr_team_data["deltatime"] < online_threshold;

        if (!online) {
            marker.icon.fillOpacity = 0.2;
            marker.icon.strokeWeight = 0.0;
        }
        else {
            marker.icon.fillOpacity = generic_icon.fillOpacity;
            marker.icon.strokeWeight = generic_icon.strokeWeight;
        }
    }

    function set_team_rotation(marker, curr_team_data) {
        var icon = marker.getIcon();
        icon.rotation = parseInt(curr_team_data['course']);
        marker.setIcon(icon);
    }

    function set_map_to_team(team_key) {
        const curr_team_data = team_markers[team_key].team_data;
        map.setCenter(get_team_loc(curr_team_data));
    }

    function callDone(data) {

        console.log(data);

        for (const key in data) {
            const team_uid = key
            const curr_team_data = data[key]

            if (!(key in team_markers)) {
                team_markers[key] = new_team_marker(curr_team_data, key);
                team_markers[key].key = key
            }
            else {
                team_markers[key].setPosition(get_team_loc(curr_team_data));
                set_team_rotation(team_markers[key], curr_team_data)
                team_markers[key].info_window.setContent(curr_team_data["name"] + "<br />" + curr_team_data["status"])
            }

            team_markers[key].team_data = curr_team_data;

            set_team_online(team_markers[key], curr_team_data)

            if (vehicle_following != null && vehicle_following == key) {
                set_map_to_team(key)
            }

        }

        setTimeout(updatePosition, delay);
    }

    function updatePosition() {
        $.ajax({
            url: 'https://fulll-send.herokuapp.com',
            dataType: 'json',
            async: true,
            crossDomain: true,
        }).done(callDone);
    }
    // call the function initally
    updatePosition();
</script>

</html>